version: v1.1.0
steps:
  - id: build-base-image-test
    when: [-]
    build: >
      -f ./Dockerfile
      -t $Registry/node-import:test
      .
  - id: az-login
    # login with the identity of the task
    # run concurrently while the image is building: when:
    when: [-]
    cmd: >
      az login --identity #> /dev/null
  - id: validate-base-image
    when: ['build-base-image-test']
    cmd: $Registry/node-import:test
    # only continues if node-import:test returns a non-zero code
  - id: import-node-to-base-artifacts
    when: ['az-login', 'validate-base-image']
    cmd: >
      az acr import 
      --name $RegistryName 
      --source $Registry/hub/node:9-alpine 
      -t base-artifacts/node:9-alpine
      -t base-artifacts/node:9-alpine-$ID
      --force
